##############################################
# KRaft Process Roles & Node Configuration
##############################################
process.roles=broker,controller
node.id={{ kafka_broker_ids[inventory_hostname] }}
# Xác định broker này nằm ở zone nào (VD: trên GCP),
# giúp Kafka phân phối các replica sang các zone khác nhau để tránh mất dữ liệu khi một zone bị sự cố
broker.rack=asia-southeast1-a

##############################################
# KRaft Controller Quorum
##############################################
# example: controller.quorum.voters=1@10.10.10.10:9093,2@0.10.10.11:9093
controller.quorum.voters={% for host in groups['kafka'] -%}
{{ kafka_broker_ids[host] }}@{{ hostvars[host]['ansible_host'] }}:9093{% if not loop.last %},{% endif %}
{%- endfor %}

##############################################
# Listener Configuration
##############################################
listeners=SASL_PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
advertised.listeners=SASL_PLAINTEXT://{{ hostvars[inventory_hostname]['ansible_host'] }}:9092
inter.broker.listener.name=SASL_PLAINTEXT
controller.listener.names=CONTROLLER

listener.security.protocol.map=\
  CONTROLLER:PLAINTEXT,\
  SASL_PLAINTEXT:SASL_PLAINTEXT,\
  PLAINTEXT:PLAINTEXT,\
  SSL:SSL,\
  SASL_SSL:SASL_SSL

sasl.enabled.mechanisms=PLAIN
sasl.mechanism.inter.broker.protocol=PLAIN
sasl.mechanism.controller.protocol=PLAIN

##############################################
# Network & I/O Optimization
##############################################
num.network.threads=8
num.io.threads=8
socket.send.buffer.bytes=1024000
socket.receive.buffer.bytes=1024000
socket.request.max.bytes=104857600

##############################################
# Producer/Consumer Message Settings
##############################################
batch.size=65536
linger.ms=10
max.message.bytes=10485760
message.max.bytes=10485760
replica.fetch.max.bytes=10485760
acks=all
default.replication.factor=1
min.insync.replicas=1
num.partitions=1
segment.bytes=536870912

##############################################
# Log Basics
##############################################
# Thư mục chứa log dữ liệu Kafka
log.dirs={{ kafka_data_dir }}/logs
# Thư mục chứa metadata log (KRaft)
metadata.log.dir={{ kafka_data_dir }}/meta
num.recovery.threads.per.data.dir=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1

##############################################
# Log Flush Policy
##############################################
log.flush.interval.messages=10000
log.flush.interval.ms=1000

##############################################
# Log Retention Policy
##############################################
# 7 days
log.retention.ms=604800000
# 20GB
log.retention.bytes=21474836480
# Align with above
log.segment.bytes=536870912
log.retention.check.interval.ms=300000

##############################################
# ACL & Authorization
##############################################
super.users=User:admin;User:ANONYMOUS;
authorizer.class.name=org.apache.kafka.metadata.authorizer.StandardAuthorizer
allow.everyone.if.no.acl.found=false
auto.create.topics.enable=true
